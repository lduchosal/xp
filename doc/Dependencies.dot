digraph ServiceDependencies {
    // Graph settings
    rankdir=LR;
    compound=true;
    node [shape=box, style=filled, fillcolor=lightblue];

    // Core infrastructure layer
    subgraph cluster_core {
        label="Core Infrastructure";
        style=filled;
        fillcolor=lightgray;

        ConbusConnectionPool [fillcolor=orange];
        EventBus [fillcolor=orange];
    }

    // Conbus services layer
    subgraph cluster_conbus {
        label="Conbus Services";
        style=filled;
        fillcolor=lightyellow;

        ConbusProtocol [fillcolor=yellow];
        ConbusDatapointService;
        ConbusOutputService;
        ConbusScanService;
        ConbusDiscoverService;
        ConbusBlinkService;
        ConbusLightlevelService;
        ConbusAutoreportService;
        ConbusLinknumberService;
        ConbusRawService;
        ConbusReceiveService;
        ConbusCustomService;

        ActionTableService;
        MsActionTableService;
    }

    // Telegram services layer
    subgraph cluster_telegram {
        label="Telegram Services";
        style=filled;
        fillcolor=lightcyan;

        TelegramService [fillcolor=orange];
        TelegramOutputService;
        TelegramDiscoverService;
        TelegramBlinkService;
        TelegramChecksumService;
        TelegramLinkNumberService;
        TelegramVersionService;
    }

    // Protocol services layer
    subgraph cluster_protocol {
        label="Protocol Services";
        style=filled;
        fillcolor=lightpink;

        TelegramFactory;
        TelegramProtocol;
    }

    // HomeKit services layer
    subgraph cluster_homekit {
        label="HomeKit Services";
        style=filled;
        fillcolor=lightgreen;

        HomekitService [fillcolor=lightgreen];
        HomekitModuleService;
        HomekitHapService;
        HomekitConbusService;
        HomekitCacheService;
        HomekitLightbulbService;
        HomekitOutletService;
        HomekitDimmingLightService;
    }

    // Server services layer
    subgraph cluster_server {
        label="Server Services";
        style=filled;
        fillcolor=wheat;

        ServerService;
        BaseServerService;
        XP20ServerService;
        XP24ServerService;
        XP33ServerService;
        XP130ServerService;
        XP230ServerService;
        CP20ServerService;
    }

    // Other services
    ReverseProxyService [fillcolor=plum];
    LogFileService [fillcolor=plum];
    ModuleTypeService [fillcolor=plum];

    // Core dependencies
    ConbusProtocol -> ConbusConnectionPool;

    // ConbusDatapointService dependencies
    ConbusDatapointService -> ConbusProtocol;
    ConbusDatapointService -> TelegramService;

    // ConbusOutputService dependencies
    ConbusOutputService -> ConbusProtocol;
    ConbusOutputService -> ConbusDatapointService;
    ConbusOutputService -> TelegramService;
    ConbusOutputService -> TelegramOutputService;

    // ConbusScanService dependencies
    ConbusScanService -> ConbusProtocol;
    ConbusScanService -> TelegramService;

    // ConbusDiscoverService dependencies
    ConbusDiscoverService -> ConbusProtocol;
    ConbusDiscoverService -> TelegramService;
    ConbusDiscoverService -> TelegramDiscoverService;

    // ConbusBlinkService dependencies
    ConbusBlinkService -> ConbusProtocol;
    ConbusBlinkService -> ConbusDiscoverService;
    ConbusBlinkService -> TelegramService;
    ConbusBlinkService -> TelegramBlinkService;

    // ConbusLightlevelService dependencies
    ConbusLightlevelService -> ConbusProtocol;
    ConbusLightlevelService -> ConbusDatapointService;
    ConbusLightlevelService -> TelegramService;

    // ActionTableService dependencies
    ActionTableService -> ConbusProtocol;
    ActionTableService -> TelegramService;

    // Telegram service dependencies
    TelegramOutputService -> TelegramService;
    TelegramDiscoverService [fillcolor=lightcyan];
    TelegramBlinkService [fillcolor=lightcyan];

    // HomeKit service dependencies
    HomekitService -> EventBus;
    HomekitService -> TelegramFactory;
    HomekitService -> TelegramService;
    HomekitService -> HomekitModuleService;
    HomekitService -> HomekitHapService;
    HomekitService -> HomekitConbusService;
    HomekitService -> HomekitCacheService;
    HomekitService -> HomekitLightbulbService;
    HomekitService -> HomekitOutletService;
    HomekitService -> HomekitDimmingLightService;

    // Protocol dependencies
    TelegramFactory -> TelegramProtocol [style=dashed, label="creates"];
    TelegramFactory -> EventBus;

    // ServerService dependencies
    ServerService -> TelegramService;
    ServerService -> TelegramDiscoverService;
    ServerService -> BaseServerService [style=dashed, label="creates"];
    ServerService -> XP20ServerService [style=dashed, label="creates"];
    ServerService -> XP24ServerService [style=dashed, label="creates"];
    ServerService -> XP33ServerService [style=dashed, label="creates"];
    ServerService -> XP130ServerService [style=dashed, label="creates"];
    ServerService -> XP230ServerService [style=dashed, label="creates"];
    ServerService -> CP20ServerService [style=dashed, label="creates"];

    // Server inheritance (all server services extend BaseServerService)
    XP20ServerService -> BaseServerService [style=dotted, label="extends"];
    XP24ServerService -> BaseServerService [style=dotted, label="extends"];
    XP33ServerService -> BaseServerService [style=dotted, label="extends"];
    XP130ServerService -> BaseServerService [style=dotted, label="extends"];
    XP230ServerService -> BaseServerService [style=dotted, label="extends"];
    CP20ServerService -> BaseServerService [style=dotted, label="extends"];

    // Legend
    subgraph cluster_legend {
        label="Legend";
        style=filled;
        fillcolor=white;

        node [shape=plaintext];
        edge [style=solid];
        legend1 [label="Solid = Direct Dependency"];
        legend2 [label="Dashed = Factory/Creates"];
        legend3 [label="Dotted = Inheritance"];

        legend1 -> legend2 [style=invis];
        legend2 -> legend3 [style=invis];
    }
}